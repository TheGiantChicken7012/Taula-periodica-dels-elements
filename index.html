<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taula Peri√≤dica v33 (Estil Glass)</title>
    
    <script>
        (function() {
            const savedTheme = localStorage.getItem('pt_theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>

    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-body: #f0f2f5; --text-main: #1a1a1a; --text-sec: #666;
            --bg-card: #ffffff; --border-color: #ccc; --bg-hover: #e9ecef;
            --primary: #007bff; --primary-hover: #0056b3;
            --accent: #6610f2;
            --cell-bg: #e0e0e0; --cell-border: #bbb; --cell-hover: #d0d0d0;
            --shadow: rgba(0,0,0,0.15);
            
            /* --- ESTATS AMB TRANSPAR√àNCIA (30% Fons / 100% Vora) --- */
            
            /* 0 Errors: Verd (Perfecte) */
            /* Fons: rgba(40, 167, 69, 0.3) -> 30% Verd */
            --st-perfect-bg: rgba(40, 167, 69, 0.3); 
            --st-perfect-br: #28a745; /* Vora s√≤lida */

            /* 1 Error: Groc/Or (B√©) */
            /* Fons: rgba(255, 193, 7, 0.3) -> 30% Groc */
            --st-good-bg:    rgba(255, 193, 7, 0.3);    
            --st-good-br:    #ffc107; 

            /* 2 Errors: Taronja (Regular) */
            /* Fons: rgba(253, 126, 20, 0.3) -> 30% Taronja */
            --st-avg-bg:     rgba(253, 126, 20, 0.3);     
            --st-avg-br:     #fd7e14;  

            /* 3+ Errors: Vermell (Malament) */
            /* Fons: rgba(220, 53, 69, 0.3) -> 30% Vermell */
            --st-bad-bg:     rgba(220, 53, 69, 0.3);     
            --st-bad-br:     #dc3545;  

            /* Pista: Blau Cian */
            /* Fons: rgba(23, 162, 184, 0.3) -> 30% Blau */
            --st-peek-bg:    rgba(23, 162, 184, 0.3);    
            --st-peek-br:    #17a2b8; 

            /* Text: Fem servir el text principal (negre/blanc) per contrast */
            --st-text-color: var(--text-main);


            /* COLORS MISSATGES ERROR (MODAL) */
            --msg-lime-bg: #d4edda; --msg-lime-br: #c3e6cb; --msg-lime-tx: #155724;
            --msg-orange-bg: #fff3cd; --msg-orange-br: #ffeeba; --msg-orange-tx: #856404;
            --msg-red-bg: #f8d7da; --msg-red-br: #f5c6cb; --msg-red-tx: #721c24;
        }

        html.dark-mode {
            --bg-body: #121212; --text-main: #e0e0e0; --text-sec: #aaaaaa;
            --bg-card: #1e1e1e; --border-color: #444; --bg-hover: #2c2c2c;
            --primary: #4da3ff; --primary-hover: #0069d9;
            --accent: #a270f5;
            --cell-bg: #2d2d2d; --cell-border: #444; --cell-hover: #404040;
            --shadow: rgba(0,0,0,0.5);
            
            /* En mode fosc, com que el fons √©s rgba, s'adaptar√† sol (es veur√† fosc) */
            /* Nom√©s redefinim els missatges del modal perqu√® siguin llegibles */
            
            --msg-lime-bg: #1e4620; --msg-lime-br: #28a745; --msg-lime-tx: #d4edda;
            --msg-orange-bg: #4d3e07; --msg-orange-br: #ffc107; --msg-orange-tx: #fff3cd;
            --msg-red-bg: #5a1e23; --msg-red-br: #dc3545; --msg-red-tx: #f8d7da;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-body); color: var(--text-main); 
            display: flex; flex-direction: column; align-items: center; 
            margin: 0; padding: 0; height: 100vh; overflow: hidden; 
        }

        /* --- MOBILE WARNING --- */
        #mobile-warning {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-body); z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; box-sizing: border-box;
        }
        @media (max-width: 700px) {
            #mobile-warning { display: flex !important; }
            .app-container { display: none !important; }
        }

        .app-container {
            width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 10px; box-sizing: border-box; position: relative;
        }

        .header-controls { position: absolute; top: 10px; right: 20px; display: flex; gap: 10px; z-index: 100;}
        .icon-btn {
            background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 16px;
            box-shadow: 0 2px 5px var(--shadow); transition: 0.3s;
        }
        .icon-btn:hover { background: var(--bg-hover); transform: translateY(-2px); }

        /* --- SETUP SCREEN --- */
        #setup-screen { 
            background: var(--bg-card); padding: 30px; border-radius: 16px; 
            box-shadow: 0 8px 30px var(--shadow); width: 95%; max-width: 1200px;
            display: flex; flex-direction: column; gap: 15px; height: 90vh;
            margin-top: 20px; overflow-y: auto;
        }
        
        .title-container { 
            display: flex; justify-content: space-between; align-items: center; 
            padding-bottom: 15px; border-bottom: 2px solid var(--border-color);
        }
        .title-center { text-align: center; flex-grow: 1; }
        h1.main-title { font-size: 2.5rem; font-weight: 800; margin: 0; letter-spacing: 1px; color: var(--primary); }
        p.subtitle { font-size: 1.2rem; margin: 5px 0 0 0; color: var(--text-sec); }

        /* TOGGLE SWITCHES */
        .toggle-container { display: flex; flex-direction: column; align-items: center; gap: 5px; min-width: 120px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider.flash-slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(24px); }
        .switch-label { font-size: 13px; font-weight: bold; color: var(--text-sec); }

        .setup-layout { display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; height: 100%; overflow: auto; padding-bottom: 20px; }
        .controls-col { flex: 1; min-width: 350px; display: flex; flex-direction: column; gap: 20px; }
        .preview-col { 
            flex: 1; min-width: 350px; display: flex; flex-direction: column; align-items: center; 
            background: var(--bg-body); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);
        }

        /* --- PRESET CARDS --- */
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .preset-card {
            background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 10px;
            padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .preset-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px var(--shadow); }
        .preset-card.active { border-color: var(--primary); background: var(--bg-hover); }
        .preset-title { font-weight: 800; font-size: 1.2rem; margin-bottom: 5px; display: block; }
        .preset-desc { font-size: 0.8rem; color: var(--text-sec); line-height: 1.2; }
        .p-green { color: #28a745; } .p-orange { color: #fd7e14; } .p-red { color: #dc3545; }

        /* ADVANCED & COMMON STYLES */
        .selector-block { background: var(--bg-hover); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .selector-block h3 { margin: 0 0 10px 0; font-size: 1.1rem; color: var(--primary); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }

        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; }
        .checkbox-item { 
            display: flex; align-items: center; justify-content: center; 
            background: var(--bg-card); border: 1px solid var(--border-color); 
            border-radius: 6px; padding: 8px; cursor: pointer; font-size: 14px; 
            user-select: none; font-weight: 500; transition: 0.2s;
        }
        .checkbox-item:hover { border-color: var(--primary); background: var(--bg-body); }
        .checkbox-item input { margin-right: 6px; }
        .checkbox-item input:checked + span { font-weight: bold; }

        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .toggle-label { display: flex; align-items: center; margin-bottom: 8px; font-size: 14px; cursor: pointer; }
        .toggle-label input { margin-right: 8px; transform: scale(1.2); }

        button.start-btn { 
            background-color: var(--primary); color: white; border: none; 
            padding: 15px 40px; border-radius: 50px; font-size: 1.5rem; 
            cursor: pointer; margin-top: 20px; width: 100%; font-weight: 800; 
            box-shadow: 0 5px 15px rgba(0,123,255,0.4); transition: transform 0.2s;
        }
        button.start-btn.flash-active { background-color: var(--accent); box-shadow: 0 5px 15px rgba(102, 16, 242, 0.4); }
        button.start-btn:hover { transform: scale(1.02); filter: brightness(1.1); }

        /* --- GAME SCREEN --- */
        #game-screen { display: none; width: 100%; height: 100%; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
        .game-header { width: 100%; display: flex; justify-content: flex-start; padding: 0 20px; box-sizing: border-box; height: 50px; align-items: center; flex-shrink: 0; background: var(--bg-card); border-bottom: 1px solid var(--border-color); }
        
        .periodic-table { display: grid; grid-template-columns: repeat(18, 1fr); grid-template-rows: repeat(10, 1fr); gap: 0.4vmin; width: 98%; height: 82%; margin: 10px auto; box-sizing: border-box; padding: 5px; }
        .periodic-table.preview-mode { width: 100%; height: auto; display: grid; gap: 2px; grid-template-rows: repeat(10, 25px); max-width: 600px; margin-top: 20px; }
        
        .element-cell { background-color: var(--cell-bg); border: 1px solid var(--cell-border); color: var(--text-main); border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; padding: 0; box-sizing: border-box; transition: transform 0.15s, z-index 0.1s, box-shadow 0.15s; user-select: none; overflow: hidden; }
        /* Efecte Hover nom√©s si no est√† fet i no √©s flashcard locked */
        .element-cell:not(.done):not(.flash-locked):hover { transform: scale(1.6); z-index: 100; box-shadow: 0 8px 20px rgba(0,0,0,0.3); border-color: var(--primary); }
        
        /* Cursor prohibit si √©s flashcard i no √©s el target */
        .element-cell.flash-locked { cursor: not-allowed; opacity: 0.5; }

        .element-cell.auto-selected { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary); z-index: 10; animation: pulse 2s infinite; }
        .element-cell.flash-target { border-color: var(--accent) !important; box-shadow: 0 0 0 3px var(--accent) !important; animation: pulse-flash 1.5s infinite; opacity: 1 !important; transform: scale(1.1); z-index: 50; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(0,123,255,0.7); } 70% { box-shadow: 0 0 0 6px rgba(0,123,255,0); } 100% { box-shadow: 0 0 0 0px rgba(0,123,255,0); } }
        @keyframes pulse-flash { 0% { box-shadow: 0 0 0 0px rgba(102, 16, 242, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(102, 16, 242, 0); } 100% { box-shadow: 0 0 0 0px rgba(102, 16, 242, 0); } }

        .element-cell.done { transform: none !important; z-index: 1 !important; opacity: 0.95; cursor: default; }
        
        /* APLICANT NOUS ESTILS (GLASS) */
        .element-cell.st-perfect { background-color: var(--st-perfect-bg); border: 2px solid var(--st-perfect-br); color: var(--st-text-color); }
        .element-cell.st-good    { background-color: var(--st-good-bg);    border: 2px solid var(--st-good-br);    color: var(--st-text-color); }
        .element-cell.st-avg     { background-color: var(--st-avg-bg);     border: 2px solid var(--st-avg-br);     color: var(--st-text-color); }
        .element-cell.st-bad     { background-color: var(--st-bad-bg);     border: 2px solid var(--st-bad-br);     color: var(--st-text-color); }
        .element-cell.st-peek    { background-color: var(--st-peek-bg);    border: 2px solid var(--st-peek-br);    color: var(--st-text-color); }

        .cell-content { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: space-between; pointer-events: none; padding: 2% 0; box-sizing: border-box; }
        .atomic-num { font-size: 1.2vmin; align-self: flex-start; margin-left: 4px; opacity: 0; line-height: 1; position: absolute; top: 2px; left: 2px; font-weight: bold; }
        .symbol { font-weight: bold; font-size: 3.5vmin; line-height: 1; opacity: 0; margin-top: 1vmin; }
        .bottom-info { display: flex; flex-direction: column; align-items: center; width: 100%; justify-content: flex-end; }
        .name-small { font-size: 1.1vmin; width: 100%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0; padding: 0 1px; }
        .atomic-mass { font-size: 1vmin; opacity: 0; font-family: monospace; margin-bottom: 2px; letter-spacing: -0.5px; }

        .element-cell.done * { opacity: 1 !important; color: inherit !important; }
        .element-cell.show-s .symbol { opacity: 1; color: var(--primary); }
        .element-cell.show-n .name-small { opacity: 1; color: var(--text-sec); }
        .element-cell.show-z .atomic-num { opacity: 1; color: var(--text-sec); }
        .element-cell.show-m .atomic-mass { opacity: 1; color: var(--text-sec); }
        .element-cell.peeking { background-color: #fff3cd !important; border-color: #ffc107 !important; }
        .element-cell.peeking * { opacity: 1 !important; color: #d39e00 !important; }

        /* MODALS & UI */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: var(--bg-card); padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); color: var(--text-main); border: 1px solid var(--border-color); }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; color: var(--text-sec); }
        .input-group input { width: 100%; padding: 12px; border: 2px solid var(--border-color); background: var(--bg-body); color: var(--text-main); border-radius: 8px; font-size: 18px; box-sizing: border-box; transition: border-color 0.2s; }
        .input-group input:focus { border-color: var(--primary); outline: none; }
        .modal-buttons { display: flex; justify-content: space-between; margin-top: 20px; gap: 15px; }
        button.action-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-check { background: var(--primary); color: white; }
        .btn-cancel { background: #6c757d; color: white; }
        
        .error-msg { display: none; margin-top: 15px; padding: 10px; border-radius: 8px; font-size: 14px; text-align: center; line-height: 1.4; border: 1px solid transparent; }
        /* Error Levels */
        .error-lime { background-color: var(--msg-lime-bg); border-color: var(--msg-lime-br); color: var(--msg-lime-tx); }
        .error-orange { background-color: var(--msg-orange-bg); border-color: var(--msg-orange-br); color: var(--msg-orange-tx); }
        .error-red { background-color: var(--msg-red-bg); border-color: var(--msg-red-br); color: var(--msg-red-tx); }

        .attempt-counter { text-align: center; margin-top: 10px; font-weight: bold; color: var(--text-sec); font-size: 12px; }

        /* --- ESTILS NOUS PER OVERRIDES MANUALS --- */
        .periodic-table.preview-mode .element-cell { pointer-events: none; }
        .periodic-table.preview-mode.interactive .element-cell { cursor: pointer; pointer-events: auto; }

        .element-cell.manual-on {
            background-color: var(--primary) !important;
            opacity: 1 !important;
            box-shadow: 0 0 0 2px var(--bg-card), 0 0 0 4px var(--accent) !important;
            border-color: var(--accent) !important;
            z-index: 10;
        }

        .element-cell.manual-off {
            background-color: var(--bg-hover) !important;
            opacity: 0.5 !important;
            border: 2px solid var(--st-bad-br) !important;
            color: var(--text-sec) !important;
            position: relative;
        }
        .element-cell.manual-off::after {
            content: "‚úï";
            position: absolute;
            color: var(--st-bad-br);
            font-size: 14px;
            font-weight: bold;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

    </style>
</head>
<body>

    <div id="mobile-warning">
        <h1>‚ö†Ô∏è</h1>
        <p>Pantalla massa estreta.</p>
        <p style="font-size:1rem; margin-top:10px">Si us plau, utilitza un ordinador.</p>
    </div>

    <div class="app-container">
        
        <div class="header-controls">
            <button class="icon-btn" onclick="toggleFullScreen()" title="Pantalla Completa">‚õ∂</button>
            <button class="icon-btn" onclick="showStats()" title="Estad√≠stiques">üìä</button>
            <button class="icon-btn" onclick="toggleTheme()" id="theme-btn" title="Mode Fosc/Clar">üåô</button>
        </div>

        <div id="setup-screen">
            <div class="title-container">
                <div class="toggle-container">
                    <label class="switch">
                        <input type="checkbox" id="mode-toggle" onchange="toggleMode()">
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label">Mode Avan√ßat</span>
                </div>
                
                <div class="title-center">
                    <h1 class="main-title">Entrenament Taula Peri√≤dica</h1>
                    <p class="subtitle">Personalitza la teva sessi√≥ d'estudi</p>
                </div>

                <div class="toggle-container">
                    <label class="switch">
                        <input type="checkbox" id="flash-toggle" onchange="toggleFlash()">
                        <span class="slider flash-slider"></span>
                    </label>
                    <span class="switch-label">Flashcard (Random)</span>
                </div>
            </div>

            <div class="setup-layout">
                <div class="controls-col">
                    
                    <div id="simple-controls">
                        <h3 style="color:var(--text-sec); border-bottom:1px solid var(--border-color); padding-bottom:5px;">Categories R√†pides</h3>
                        <div class="preset-grid">
                            <div class="preset-card" onclick="applyPreset('senzill')">
                                <span class="preset-title p-green">Senzill</span>
                                <span class="preset-desc">Grups 1, 2, 17, 18<br>(Tota la columna)</span>
                            </div>
                            <div class="preset-card" onclick="applyPreset('mitja')">
                                <span class="preset-title p-orange">Mitj√†</span>
                                <span class="preset-desc">G 1, 2, 10-18<br>+ Filera 4</span>
                            </div>
                            <div class="preset-card" onclick="applyPreset('expert')">
                                <span class="preset-title p-red">Expert</span>
                                <span class="preset-desc">Tota la Taula<br>+ Lant/Act</span>
                            </div>
                        </div>
                        
                        <div class="selector-block">
                            <h3>Configuraci√≥ Simple</h3>
                            <div class="options-grid">
                                <div>
                                    <label class="toggle-label" title="Si s'activa, veur√†s tota la informaci√≥ de l'element. Si no, estar√† buit."><input type="checkbox" id="simple-solucionari" onchange="syncSimpleToAdvanced()"> üëÅÔ∏è Solucionari</label>
                                </div>
                                <div>
                                    <label class="toggle-label"><input type="checkbox" id="req-numbers-simple" onchange="syncSimpleToAdvanced()"> Demanar Z</label>
                                    <label class="toggle-label"><input type="checkbox" id="req-mass-simple" onchange="syncSimpleToAdvanced()"> Demanar Massa (2 dec)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="advanced-controls" style="display:none;">
                        <div class="selector-block">
                            <h3>1. Grups (Columnes)</h3>
                            <div class="checkbox-grid" id="group-checkboxes"></div>
                            <div style="margin-top:10px; display:flex; gap:15px; justify-content:flex-end;">
                                <span style="font-size: 13px; color: var(--primary); cursor:pointer; font-weight:bold;" onclick="toggleAll('g', true)">‚úÖ Seleccionar Tot</span>
                                <span style="font-size: 13px; color: var(--text-sec); cursor:pointer;" onclick="toggleAll('g', false)">‚ùå Deseleccionar</span>
                            </div>
                        </div>
                        
                        <div class="selector-block" style="margin-top:15px;">
                            <h3>2. Per√≠odes (Files)</h3>
                            <div class="checkbox-grid" id="period-checkboxes-std"></div>
                            <div style="margin-top:10px; display:flex; gap:10px; border-top:1px solid var(--border-color); padding-top:10px;">
                                <label class="checkbox-item" style="flex:1"><input type="checkbox" id="lant" onchange="saveConfig(); updatePreview()"> Lant√†nids</label>
                                <label class="checkbox-item" style="flex:1"><input type="checkbox" id="act" onchange="saveConfig(); updatePreview()"> Act√≠nids</label>
                            </div>
                            <div style="margin-top:10px; display:flex; gap:15px; justify-content:flex-end;">
                                <span style="font-size: 13px; color: var(--primary); cursor:pointer; font-weight:bold;" onclick="toggleAll('p', true)">‚úÖ Seleccionar Tot</span>
                                <span style="font-size: 13px; color: var(--text-sec); cursor:pointer;" onclick="toggleAll('p', false)">‚ùå Deseleccionar</span>
                            </div>
                        </div>
                        
                        <div class="selector-block" style="margin-top:15px;">
                            <h3>3. Configuraci√≥ Detallada</h3>
                            <div class="options-grid">
                                <div class="option-group">
                                    <label class="toggle-label"><input type="checkbox" id="req-numbers" onchange="syncAdvancedToSimple()"> Demanar Z</label>
                                    <label class="toggle-label"><input type="checkbox" id="req-mass" onchange="syncAdvancedToSimple()"> Demanar Massa</label>
                                </div>
                                <div class="option-group">
                                    <label class="toggle-label"><input type="checkbox" id="hint-symbols" onchange="updateSolucionariCheck()"> Veure S√≠mbol</label>
                                    <label class="toggle-label"><input type="checkbox" id="hint-names" onchange="updateSolucionariCheck()"> Veure Nom</label>
                                    <label class="toggle-label"><input type="checkbox" id="hint-z" onchange="saveConfig(); updatePreview()"> Veure Z</label>
                                    <label class="toggle-label"><input type="checkbox" id="hint-m" onchange="saveConfig(); updatePreview()"> Veure Massa</label>
                                </div>
                            </div>
                            <div style="margin-top:15px;">
                                 <div style="font-size:13px; display:flex; justify-content:space-between; margin-bottom:5px;">
                                     <span>Precisi√≥ Massa:</span><span id="prec-val" style="font-weight:bold; color:var(--primary);">2 dec.</span>
                                 </div>
                                 <input type="range" id="mass-precision" min="0" max="4" value="2" style="width:100%; cursor:pointer;" oninput="saveConfig(); updatePrecisionLabel()">
                            </div>
                        </div>
                    </div>

                </div>

                <div class="preview-col">
                    <h4 style="margin-top:0; color:var(--text-sec); text-transform:uppercase; letter-spacing:1px; font-size:12px;">Previsualitzaci√≥ del tauler</h4>
                    <div id="preview-grid" class="periodic-table preview-mode"></div>
                    <div style="margin-top:auto; width:100%;">
                        <button id="start-btn-main" class="start-btn" onclick="startGame()">COMEN√áAR</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-screen">
            <div class="game-header">
                <button onclick="goBack()" style="background:var(--bg-hover); color: var(--text-main); border:1px solid var(--border-color); padding: 8px 15px; border-radius:6px; cursor:pointer; font-weight:bold;">‚¨Ö Tornar al Men√∫</button>
                <div style="margin-left:auto; font-size:13px; color:var(--text-sec); font-weight:500;">
                    <span style="margin-right:15px;">üí° Mantingues ESPAI per solucions</span>
                </div>
            </div>
            
            <div class="periodic-table" id="pt-grid"></div>
        </div>

        <footer style="margin-top: auto; padding: 10px; text-align: center; font-size: 11px; color: var(--text-sec); width: 100%; background: var(--bg-body);">
            <p style="margin: 5px 0;">Aquesta obra de <strong>TheGiantChicken7012</strong> est√† subjecta a una 
                <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" style="color: var(--primary); text-decoration: none;">
                    Llic√®ncia Creative Commons Reconeixement-NoComercial-CompartirIgual 4.0 Internacional
                </a>.
            </p>
            <p style="margin:0;">¬© 2026 - Creat per a l'estudi de la Taula Peri√≤dica</p>
        </footer>

        <div id="modal-overlay" class="modal-overlay">
            <div id="modal-box" class="modal-box">
                <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:10px;">Endevina l'element</h3>
                <div class="input-group"><label>S√≠mbol Qu√≠mic</label><input type="text" id="input-symbol" placeholder="Ex: Fe" autocomplete="off"></div>
                <div class="input-group"><label>Nom de l'element</label><input type="text" id="input-name" placeholder="Ex: Ferro" autocomplete="off"></div>
                <div class="input-group" id="input-z-group" style="display:none;"><label>N√∫mero At√≤mic (Z)</label><input type="number" id="input-z" placeholder="Ex: 26"></div>
                <div class="input-group" id="input-m-group" style="display:none;"><label>Massa At√≤mica (u)</label><input type="text" id="input-m" placeholder="Ex: 55.85"></div>
                
                <div class="error-msg" id="error-msg"></div>
                
                <div class="attempt-counter" id="attempt-counter">Intent 1 de 3</div>
                <div class="modal-buttons">
                    <button class="action-btn btn-cancel" onclick="closeModal()">Tancar</button>
                    <button class="action-btn btn-check" onclick="checkAnswer()">Comprovar</button>
                </div>
            </div>
        </div>

        <div id="stats-overlay" class="modal-overlay">
            <div class="modal-box" style="width: 500px;">
                <h2 style="margin-top:0; text-align:center;">üìä Resultats</h2>
                <div style="display:flex; justify-content:space-around; margin-bottom:20px; text-align:center;">
                    <div style="background:var(--bg-hover); padding:10px; border-radius:8px; min-width:80px;"><span style="font-size:20px; font-weight:bold; display:block;" id="st-time">00:00</span><span style="font-size:12px; color:var(--text-sec);">Temps</span></div>
                    <div style="background:var(--bg-hover); padding:10px; border-radius:8px; min-width:80px;"><span style="font-size:20px; font-weight:bold; display:block;" id="st-total">0/0</span><span style="font-size:12px; color:var(--text-sec);">Completats</span></div>
                </div>
                <div id="stats-lists" style="max-height:300px; overflow-y:auto; text-align:left; font-size:14px;"></div>
                <button class="action-btn btn-check" style="width:100%; margin-top:20px;" onclick="document.getElementById('stats-overlay').style.display='none'">Tancar</button>
            </div>
        </div>
    </div>

<script>
    const db = [
        {z:1, s:"H", n:"Hidrogen", m:1.008, g:1, p:1}, {z:2, s:"He", n:"Heli", m:4.0026, g:18, p:1},
        {z:3, s:"Li", n:"Liti", m:6.94, g:1, p:2}, {z:4, s:"Be", n:"Beril¬∑li", m:9.0122, g:2, p:2}, {z:5, s:"B", n:"Bor", m:10.81, g:13, p:2}, {z:6, s:"C", n:"Carboni", m:12.011, g:14, p:2}, {z:7, s:"N", n:"Nitrogen", m:14.007, g:15, p:2}, {z:8, s:"O", n:"Oxigen", m:15.999, g:16, p:2}, {z:9, s:"F", n:"Fluor", m:18.998, g:17, p:2}, {z:10, s:"Ne", n:"Ne√≥", m:20.180, g:18, p:2},
        {z:11, s:"Na", n:"Sodi", m:22.990, g:1, p:3}, {z:12, s:"Mg", n:"Magnesi", m:24.305, g:2, p:3}, {z:13, s:"Al", n:"Alumini", m:26.982, g:13, p:3}, {z:14, s:"Si", n:"Silici", m:28.085, g:14, p:3}, {z:15, s:"P", n:"F√≤sfor", m:30.974, g:15, p:3}, {z:16, s:"S", n:"Sofre", m:32.06, g:16, p:3}, {z:17, s:"Cl", n:"Clor", m:35.45, g:17, p:3}, {z:18, s:"Ar", n:"Arg√≥", m:39.948, g:18, p:3},
        {z:19, s:"K", n:"Potassi", m:39.098, g:1, p:4}, {z:20, s:"Ca", n:"Calci", m:40.078, g:2, p:4}, {z:21, s:"Sc", n:"Escandi", m:44.956, g:3, p:4}, {z:22, s:"Ti", n:"Titani", m:47.867, g:4, p:4}, {z:23, s:"V", n:"Vanadi", m:50.942, g:5, p:4}, {z:24, s:"Cr", n:"Crom", m:51.996, g:6, p:4}, {z:25, s:"Mn", n:"Mangan√®s", m:54.938, g:7, p:4}, {z:26, s:"Fe", n:"Ferro", m:55.845, g:8, p:4}, {z:27, s:"Co", n:"Cobalt", m:58.933, g:9, p:4}, {z:28, s:"Ni", n:"N√≠quel", m:58.693, g:10, p:4}, {z:29, s:"Cu", n:"Coure", m:63.546, g:11, p:4}, {z:30, s:"Zn", n:"Zinc", m:65.38, g:12, p:4}, {z:31, s:"Ga", n:"Gal¬∑li", m:69.723, g:13, p:4}, {z:32, s:"Ge", n:"Germani", m:72.630, g:14, p:4}, {z:33, s:"As", n:"Ars√®nic", m:74.922, g:15, p:4}, {z:34, s:"Se", n:"Seleni", m:78.971, g:16, p:4}, {z:35, s:"Br", n:"Brom", m:79.904, g:17, p:4}, {z:36, s:"Kr", n:"Cript√≥", m:83.798, g:18, p:4},
        {z:37, s:"Rb", n:"Rubidi", m:85.468, g:1, p:5}, {z:38, s:"Sr", n:"Estronci", m:87.62, g:2, p:5}, {z:39, s:"Y", n:"Itri", m:88.906, g:3, p:5}, {z:40, s:"Zr", n:"Zirconi", m:91.224, g:4, p:5}, {z:41, s:"Nb", n:"Niobi", m:92.906, g:5, p:5}, {z:42, s:"Mo", n:"Molibd√®", m:95.95, g:6, p:5}, {z:43, s:"Tc", n:"Tecneci", m:98, g:7, p:5}, {z:44, s:"Ru", n:"Ruteni", m:101.07, g:8, p:5}, {z:45, s:"Rh", n:"Rodi", m:102.91, g:9, p:5}, {z:46, s:"Pd", n:"Pal¬∑ladi", m:106.42, g:10, p:5}, {z:47, s:"Ag", n:"Argent", m:107.87, g:11, p:5}, {z:48, s:"Cd", n:"Cadmi", m:112.41, g:12, p:5}, {z:49, s:"In", n:"Indi", m:114.82, g:13, p:5}, {z:50, s:"Sn", n:"Estany", m:118.71, g:14, p:5}, {z:51, s:"Sb", n:"Antimoni", m:121.76, g:15, p:5}, {z:52, s:"Te", n:"Tel¬∑luri", m:127.60, g:16, p:5}, {z:53, s:"I", n:"Iode", m:126.90, g:17, p:5}, {z:54, s:"Xe", n:"Xen√≥", m:131.29, g:18, p:5},
        {z:55, s:"Cs", n:"Cesi", m:132.91, g:1, p:6}, {z:56, s:"Ba", n:"Bari", m:137.33, g:2, p:6}, {z:57, s:"La", n:"Lant√†", m:138.91, g:3, p:6}, {z:72, s:"Hf", n:"Hafni", m:178.49, g:4, p:6}, {z:73, s:"Ta", n:"T√†ntal", m:180.95, g:5, p:6}, {z:74, s:"W", n:"Tungst√®", m:183.84, g:6, p:6}, {z:75, s:"Re", n:"Reni", m:186.21, g:7, p:6}, {z:76, s:"Os", n:"Osmi", m:190.23, g:8, p:6}, {z:77, s:"Ir", n:"Iridi", m:192.22, g:9, p:6}, {z:78, s:"Pt", n:"Plat√≠", m:195.08, g:10, p:6}, {z:79, s:"Au", n:"Or", m:196.97, g:11, p:6}, {z:80, s:"Hg", n:"Mercuri", m:200.59, g:12, p:6}, {z:81, s:"Tl", n:"Tal¬∑li", m:204.38, g:13, p:6}, {z:82, s:"Pb", n:"Plom", m:207.2, g:14, p:6}, {z:83, s:"Bi", n:"Bismut", m:208.98, g:15, p:6}, {z:84, s:"Po", n:"Poloni", m:209, g:16, p:6}, {z:85, s:"At", n:"√Ästat", m:210, g:17, p:6}, {z:86, s:"Rn", n:"Rad√≥", m:222, g:18, p:6},
        {z:87, s:"Fr", n:"Franci", m:223, g:1, p:7}, {z:88, s:"Ra", n:"Radi", m:226, g:2, p:7}, {z:89, s:"Ac", n:"Actini", m:227, g:3, p:7}, {z:104, s:"Rf", n:"Rutherfordi", m:267, g:4, p:7}, {z:105, s:"Db", n:"Dubni", m:268, g:5, p:7}, {z:106, s:"Sg", n:"Seaborgi", m:269, g:6, p:7}, {z:107, s:"Bh", n:"Bohri", m:270, g:7, p:7}, {z:108, s:"Hs", n:"Hassi", m:277, g:8, p:7}, {z:109, s:"Mt", n:"Meitneri", m:278, g:9, p:7}, {z:110, s:"Ds", n:"Darmstadti", m:281, g:10, p:7}, {z:111, s:"Rg", n:"Roentgeni", m:282, g:11, p:7}, {z:112, s:"Cn", n:"Copernici", m:285, g:12, p:7}, {z:113, s:"Nh", n:"Nihoni", m:286, g:13, p:7}, {z:114, s:"Fl", n:"Flerovi", m:289, g:14, p:7}, {z:115, s:"Mc", n:"Moscovi", m:290, g:15, p:7}, {z:116, s:"Lv", n:"Livermori", m:293, g:16, p:7}, {z:117, s:"Ts", n:"Tennessin", m:294, g:17, p:7}, {z:118, s:"Og", n:"Oganess√≥", m:294, g:18, p:7},
        {z:58, s:"Ce", n:"Ceri", m:140.12, g:null, p:6, vRow:9, vCol:4}, {z:59, s:"Pr", n:"Praseodimi", m:140.91, g:null, p:6, vRow:9, vCol:5}, {z:60, s:"Nd", n:"Neodimi", m:144.24, g:null, p:6, vRow:9, vCol:6}, {z:61, s:"Pm", n:"Prometi", m:145, g:null, p:6, vRow:9, vCol:7}, {z:62, s:"Sm", n:"Samari", m:150.36, g:null, p:6, vRow:9, vCol:8}, {z:63, s:"Eu", n:"Europi", m:151.96, g:null, p:6, vRow:9, vCol:9}, {z:64, s:"Gd", n:"Gadolini", m:157.25, g:null, p:6, vRow:9, vCol:10}, {z:65, s:"Tb", n:"Terbi", m:158.93, g:null, p:6, vRow:9, vCol:11}, {z:66, s:"Dy", n:"Disprosi", m:162.50, g:null, p:6, vRow:9, vCol:12}, {z:67, s:"Ho", n:"Holmi", m:164.93, g:null, p:6, vRow:9, vCol:13}, {z:68, s:"Er", n:"Erbi", m:167.26, g:null, p:6, vRow:9, vCol:14}, {z:69, s:"Tm", n:"Tul¬∑li", m:168.93, g:null, p:6, vRow:9, vCol:15}, {z:70, s:"Yb", n:"Iterbi", m:173.05, g:null, p:6, vRow:9, vCol:16}, {z:71, s:"Lu", n:"Luteci", m:174.97, g:null, p:6, vRow:9, vCol:17},
        {z:90, s:"Th", n:"Tori", m:232.04, g:null, p:7, vRow:10, vCol:4}, {z:91, s:"Pa", n:"Protactini", m:231.04, g:null, p:7, vRow:10, vCol:5}, {z:92, s:"U", n:"Urani", m:238.03, g:null, p:7, vRow:10, vCol:6}, {z:93, s:"Np", n:"Neptuni", m:237, g:null, p:7, vRow:10, vCol:7}, {z:94, s:"Pu", n:"Plutoni", m:244, g:null, p:7, vRow:10, vCol:8}, {z:95, s:"Am", n:"Americi", m:243, g:null, p:7, vRow:10, vCol:9}, {z:96, s:"Cm", n:"Curi", m:247, g:null, p:7, vRow:10, vCol:10}, {z:97, s:"Bk", n:"Berkeli", m:247, g:null, p:7, vRow:10, vCol:11}, {z:98, s:"Cf", n:"Californi", m:251, g:null, p:7, vRow:10, vCol:12}, {z:99, s:"Es", n:"Einsteini", m:252, g:null, p:7, vRow:10, vCol:13}, {z:100, s:"Fm", n:"Fermi", m:257, g:null, p:7, vRow:10, vCol:14}, {z:101, s:"Md", n:"Mendelevi", m:258, g:null, p:7, vRow:10, vCol:15}, {z:102, s:"No", n:"Nobeli", m:259, g:null, p:7, vRow:10, vCol:16}, {z:103, s:"Lr", n:"Lawrenci", m:262, g:null, p:7, vRow:10, vCol:17}
    ];

    let gameState = { startTime: null, elements: {}, activeList: [], verticalOrder: [] };
    let conf = { reqZ: false, reqM: false, hintS: false, hintN: false, hintZ: false, hintM: false, prec: 2, isAdvanced: false, isFlashcard: false };
    
    // VARIABLE CLAU PER ALS OVERRIDES MANUALS
    let manualOverrides = {}; 
    
    let currentTarget = null; let currentCell = null; let autoSelectedZ = null; let hoveredZ = null;

    document.addEventListener('DOMContentLoaded', () => { 
        const btn = document.getElementById('theme-btn');
        if (document.documentElement.classList.contains('dark-mode')) btn.innerText = '‚òÄÔ∏è';
        initCheckboxes(); loadConfig(); updatePrecisionLabel(); updatePreview();
    });

    function toggleTheme() {
        document.documentElement.classList.toggle('dark-mode');
        const isDark = document.documentElement.classList.contains('dark-mode');
        document.getElementById('theme-btn').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('pt_theme', isDark ? 'dark' : 'light');
    }
    
    function toggleFullScreen() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if (document.exitFullscreen) document.exitFullscreen();
    }

    // --- MODE SWITCHER ---
    function toggleMode() {
        conf.isAdvanced = document.getElementById('mode-toggle').checked;
        
        if (!conf.isAdvanced) {
            manualOverrides = {}; // Neteja overrides si tornem a simple
        }

        setModeUI(conf.isAdvanced);
        saveConfig();
        updatePreview(); // Re-render per treure/posar mode interactiu
    }
    
    function toggleFlash() {
        conf.isFlashcard = document.getElementById('flash-toggle').checked;
        const btn = document.getElementById('start-btn-main');
        if (conf.isFlashcard) {
            btn.innerText = "COMEN√áAR (FLASH)";
            btn.classList.add('flash-active');
        } else {
            btn.innerText = "COMEN√áAR";
            btn.classList.remove('flash-active');
        }
        saveConfig();
    }

    function setModeUI(isAdvanced) {
        document.getElementById('simple-controls').style.display = isAdvanced ? 'none' : 'block';
        document.getElementById('advanced-controls').style.display = isAdvanced ? 'block' : 'none';
        
        if (!isAdvanced) {
            document.getElementById('mass-precision').value = 2;
            updatePrecisionLabel();
        }
    }

    // --- PRESETS (SIMPLE MODE) ---
    function applyPreset(type) {
        manualOverrides = {}; // NETEJA OVERRIDES

        // Reset selections
        for(let i=1; i<=18; i++) document.getElementById(`g${i}`).checked = false;
        for(let i=1; i<=7; i++) document.getElementById(`p${i}`).checked = false;
        document.getElementById('lant').checked = false;
        document.getElementById('act').checked = false;

        if (type === 'senzill') {
            // INSTRUCCI√ì: Les columnes 1, 2, 17 i 18
            [1, 2, 17, 18].forEach(g => document.getElementById(`g${g}`).checked = true);
        } else if (type === 'mitja') {
            // INSTRUCCI√ì: Les columnes 1, 2, 10-18 + Filera 4
            [1, 2, 10, 11, 12, 13, 14, 15, 16, 17, 18].forEach(g => document.getElementById(`g${g}`).checked = true);
            document.getElementById('p4').checked = true;
        } else if (type === 'expert') {
            toggleAll('g', true);
            toggleAll('p', true);
        }
        
        saveConfig();
        updatePreview();
    }

    // --- SYNC FUNCTIONS ---
    function syncSimpleToAdvanced() {
        document.getElementById('req-numbers').checked = document.getElementById('req-numbers-simple').checked;
        document.getElementById('req-mass').checked = document.getElementById('req-mass-simple').checked;
        
        const isSol = document.getElementById('simple-solucionari').checked;
        document.getElementById('hint-symbols').checked = isSol;
        document.getElementById('hint-names').checked = isSol;
        document.getElementById('hint-z').checked = isSol;
        document.getElementById('hint-m').checked = isSol;
        
        saveConfig(); updatePreview();
    }

    function syncAdvancedToSimple() {
        document.getElementById('req-numbers-simple').checked = document.getElementById('req-numbers').checked;
        document.getElementById('req-mass-simple').checked = document.getElementById('req-mass').checked;
        updateSolucionariCheck();
        saveConfig(); updatePreview();
    }

    function updateSolucionariCheck() {
        const hS = document.getElementById('hint-symbols').checked;
        const hN = document.getElementById('hint-names').checked;
        const hZ = document.getElementById('hint-z').checked;
        const hM = document.getElementById('hint-m').checked;
        document.getElementById('simple-solucionari').checked = (hS && hN && hZ && hM);
    }

    // --- CORE CONFIG ---
    function saveConfig() {
        const config = {
            isAdvanced: document.getElementById('mode-toggle').checked,
            isFlashcard: document.getElementById('flash-toggle').checked,
            groups: [], periods: [],
            lant: document.getElementById('lant').checked,
            act: document.getElementById('act').checked,
            reqZ: document.getElementById('req-numbers').checked,
            reqM: document.getElementById('req-mass').checked,
            hintS: document.getElementById('hint-symbols').checked,
            hintN: document.getElementById('hint-names').checked,
            hintZ: document.getElementById('hint-z').checked,
            hintM: document.getElementById('hint-m').checked,
            prec: document.getElementById('mass-precision').value
        };
        for(let i=1; i<=18; i++) { if(document.getElementById(`g${i}`).checked) config.groups.push(i); }
        for(let i=1; i<=7; i++) { const el = document.getElementById(`p${i}`); if(el && el.checked) config.periods.push(i); }
        localStorage.setItem('pt_config_v31', JSON.stringify(config));
    }

    function loadConfig() {
        const json = localStorage.getItem('pt_config_v31');
        if(!json) { 
            toggleAll('g', true); toggleAll('p', true); 
            setModeUI(false);
            return; 
        }
        try {
            const config = JSON.parse(json);
            
            document.getElementById('mode-toggle').checked = !!config.isAdvanced;
            setModeUI(!!config.isAdvanced);
            
            document.getElementById('flash-toggle').checked = !!config.isFlashcard;
            toggleFlash(); 

            for(let i=1; i<=18; i++) { const el = document.getElementById(`g${i}`); if(el) el.checked = false; }
            for(let i=1; i<=7; i++) { const el = document.getElementById(`p${i}`); if(el) el.checked = false; }
            if (config.groups) config.groups.forEach(i => { const el = document.getElementById(`g${i}`); if(el) el.checked = true; });
            if (config.periods) config.periods.forEach(i => { const el = document.getElementById(`p${i}`); if(el) el.checked = true; });
            
            document.getElementById('lant').checked = !!config.lant;
            document.getElementById('act').checked = !!config.act;
            
            document.getElementById('req-numbers').checked = !!config.reqZ;
            document.getElementById('req-mass').checked = !!config.reqM;
            document.getElementById('hint-symbols').checked = !!config.hintS;
            document.getElementById('hint-names').checked = !!config.hintN;
            document.getElementById('hint-z').checked = !!config.hintZ;
            document.getElementById('hint-m').checked = !!config.hintM;
            document.getElementById('mass-precision').value = config.prec || 2;

            syncAdvancedToSimple();

        } catch (e) { toggleAll('g', true); toggleAll('p', true); }
    }

    function initCheckboxes() {
        const groupCont = document.getElementById('group-checkboxes');
        let html = '';
        for (let i=1; i<=18; i++) html += `<label class="checkbox-item"><input type="checkbox" value="${i}" id="g${i}" onchange="saveConfig(); updatePreview()"> <span>G${i}</span></label>`;
        groupCont.innerHTML = html;
        const periodCont = document.getElementById('period-checkboxes-std');
        html = '';
        for (let i=1; i<=7; i++) html += `<label class="checkbox-item"><input type="checkbox" value="${i}" id="p${i}" onchange="saveConfig(); updatePreview()"> <span>P${i}</span></label>`;
        periodCont.innerHTML = html;
    }

    function toggleAll(type, state) {
        if (type === 'g') { for (let i=1; i<=18; i++) { const el = document.getElementById(`g${i}`); if(el) el.checked = state; } } 
        else { for (let i=1; i<=7; i++) { const el = document.getElementById(`p${i}`); if(el) el.checked = state; } document.getElementById('lant').checked = state; document.getElementById('act').checked = state; }
        saveConfig(); updatePreview();
    }
    
    function updatePrecisionLabel() {
        const val = document.getElementById('mass-precision').value;
        document.getElementById('prec-val').innerText = val == 0 ? "Enter" : val + " decimals";
    }

    // --- NOVA FUNCI√ì AUXILIAR ---
    function isConfigActive(el) {
        const selGroups = [];
        for (let i=1; i<=18; i++) if(document.getElementById(`g${i}`).checked) selGroups.push(i);
        
        const selPeriods = [];
        for (let i=1; i<=7; i++) { const p = document.getElementById(`p${i}`); if(p && p.checked) selPeriods.push(i); }
        
        const wantLant = document.getElementById('lant').checked;
        const wantAct = document.getElementById('act').checked;

        if (selGroups.length === 0 && selPeriods.length === 0 && !wantLant && !wantAct) return false;

        if (el.vRow) { 
            if (el.p === 6 && wantLant) return true; 
            if (el.p === 7 && wantAct) return true; 
            return false; 
        } 
        
        const inGroup = el.g !== null && selGroups.includes(el.g);
        const inPeriod = selPeriods.includes(el.p);
        
        // Uni√≥ (OR)
        if (selGroups.length === 0) return inPeriod;
        if (selPeriods.length === 0) return inGroup;
        return inGroup || inPeriod;
    }

    // --- NOVA FUNCI√ì: TOGGLE MANUAL ---
    function toggleManualElement(z) {
        if (!conf.isAdvanced) return; // Nom√©s mode avan√ßat

        const el = db.find(e => e.z === z);
        if (!el) return;

        const configState = isConfigActive(el);
        const currentState = manualOverrides[z];

        if (currentState === undefined) {
            manualOverrides[z] = !configState;
        } else if (currentState === !configState) {
            delete manualOverrides[z];
        } else {
            delete manualOverrides[z]; 
        }

        updatePreview();
    }

    // --- SELECTION LOGIC ---
    function getActiveElements() {
        return db.filter(el => {
            // Prioritat Overrides
            if (manualOverrides[el.z] === true) return true;
            if (manualOverrides[el.z] === false) return false;

            // Config
            return isConfigActive(el);
        });
    }

    function updatePreview() {
        const hS = document.getElementById('hint-symbols').checked;
        const hN = document.getElementById('hint-names').checked;
        const hZ = document.getElementById('hint-z').checked;
        const hM = document.getElementById('hint-m').checked;

        const grid = document.getElementById('preview-grid');
        grid.innerHTML = '';
        
        if (conf.isAdvanced) grid.classList.add('interactive');
        else grid.classList.remove('interactive');
        
        db.forEach(el => {
            const cell = document.createElement('div');
            // Click handler per override manual
            cell.onclick = () => toggleManualElement(el.z);
            
            const configActive = isConfigActive(el);
            const override = manualOverrides[el.z];
            
            let isVisible = configActive;
            let className = 'element-cell';

            if (override === true) {
                isVisible = true;
                className += ' manual-on';
            } else if (override === false) {
                isVisible = false;
                className += ' manual-off';
            } else {
                isVisible = configActive;
            }

            cell.className = className;

            if (isVisible) { 
                if (!cell.classList.contains('manual-on')) {
                    cell.style.background = 'var(--primary)'; 
                    cell.style.borderColor = 'var(--primary-hover)';
                }
                cell.style.opacity = '0.9'; 
                
                if(hS) cell.classList.add('show-s');
                if(hN) cell.classList.add('show-n');
                if(hZ) cell.classList.add('show-z');
                if(hM) cell.classList.add('show-m');
                
                cell.innerHTML = `<div class="cell-content" style="pointer-events:none; padding:1px;">
                    <span class="atomic-num" style="font-size:8px;">${el.z}</span>
                    <span class="symbol" style="font-size:10px; color:white; margin:0;">${el.s}</span>
                </div>`;
            } else { 
                if (!cell.classList.contains('manual-off')) {
                    cell.style.opacity = '0.3'; 
                }
            }

            let col = el.g, row = el.p;
            if (el.vRow) { row = el.vRow; col = el.vCol; } 
            cell.style.gridColumn = col; cell.style.gridRow = row;
            grid.appendChild(cell);
        });
    }

    function goBack() { 
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('setup-screen').style.display = 'flex';
        document.querySelector('.header-controls').style.display = 'flex';
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function startGame() {
        const gameElements = getActiveElements();
        if (gameElements.length === 0) { alert("Has de seleccionar almenys un grup o per√≠ode!"); return; }
        
        conf.reqZ = document.getElementById('req-numbers').checked;
        conf.reqM = document.getElementById('req-mass').checked;
        conf.hintS = document.getElementById('hint-symbols').checked;
        conf.hintN = document.getElementById('hint-names').checked;
        conf.hintZ = document.getElementById('hint-z').checked;
        conf.hintM = document.getElementById('hint-m').checked;
        conf.prec = document.getElementById('mass-precision').value;
        conf.isFlashcard = document.getElementById('flash-toggle').checked;

        gameState.startTime = Date.now();
        gameState.elements = {};
        gameState.activeList = gameElements.map(e => e.z);

        if (conf.isFlashcard) {
            let shuffled = [...gameElements];
            shuffleArray(shuffled);
            gameState.verticalOrder = shuffled.map(e => e.z);
        } else {
            gameState.verticalOrder = [...gameElements].sort((a,b) => {
                const colA = a.vCol || a.g; const colB = b.vCol || b.g;
                if (colA !== colB) return colA - colB;
                return (a.vRow || a.p) - (b.vRow || b.p);
            }).map(e => e.z);
        }

        gameElements.forEach(el => { gameState.elements[el.z] = { attempts: 0, status: 'pending', peeked: false }; });
        
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex'; 
        renderGrid(gameElements);
        
        document.addEventListener('keydown', handleGlobalKeyDown);
        document.addEventListener('keyup', handleGlobalKeyUp);
        
        findNextTarget(); 
    }

    function handleGlobalKeyDown(e) {
        if (e.code === 'Space' && hoveredZ && document.getElementById('modal-overlay').style.display === 'none') {
            e.preventDefault(); 
            const cell = document.querySelector(`.element-cell[data-z="${hoveredZ}"]`);
            if (conf.isFlashcard && hoveredZ !== autoSelectedZ) return;
            
            if (cell && !cell.classList.contains('done')) {
                cell.classList.add('peeking');
                gameState.elements[hoveredZ].peeked = true;
            }
        }
        if (e.key === 'Enter' && document.getElementById('modal-overlay').style.display === 'none') {
            if (autoSelectedZ) {
                e.preventDefault(); e.stopPropagation();
                const el = db.find(x => x.z === autoSelectedZ);
                const cell = document.querySelector(`.element-cell[data-z="${autoSelectedZ}"]`);
                if (el && cell && !cell.classList.contains('done')) openModal(el, cell);
            }
        }
    }

    function handleGlobalKeyUp(e) {
        if (e.code === 'Space') document.querySelectorAll('.peeking').forEach(c => c.classList.remove('peeking'));
    }

    function formatMass(m) { return parseFloat(m).toFixed(conf.prec); }

    function renderGrid(elementsToShow) {
        const grid = document.getElementById('pt-grid');
        grid.innerHTML = '';
        elementsToShow.forEach(el => {
            const cell = document.createElement('div');
            cell.className = 'element-cell'; cell.dataset.z = el.z;
            cell.onmouseenter = () => hoveredZ = el.z;
            cell.onmouseleave = () => hoveredZ = null;
            cell.onclick = () => openModal(el, cell);
            if (conf.hintS) cell.classList.add('show-s');
            if (conf.hintN) cell.classList.add('show-n');
            if (conf.hintZ) cell.classList.add('show-z');
            if (conf.hintM) cell.classList.add('show-m');
            let col = el.g, row = el.p;
            if (el.vRow) { row = el.vRow; col = el.vCol; } 
            cell.style.gridColumn = col; cell.style.gridRow = row;
            cell.innerHTML = `<div class="cell-content"><span class="atomic-num">${el.z}</span><span class="symbol">${el.s}</span><div class="bottom-info"><div class="name-small">${el.n}</div><div class="atomic-mass">${formatMass(el.m)}</div></div></div>`;
            grid.appendChild(cell);
        });
    }

    function openModal(el, cell) {
        if (conf.isFlashcard && el.z !== autoSelectedZ) return;
        if (cell.classList.contains('done')) return;
        document.querySelectorAll('.peeking').forEach(c => c.classList.remove('peeking'));
        currentTarget = el; currentCell = cell;
        
        const msgBox = document.getElementById('error-msg');
        msgBox.style.display = 'none';
        msgBox.className = 'error-msg'; 

        setupModalField('input-symbol', conf.hintS ? el.s : '', !conf.hintS);
        setupModalField('input-name', conf.hintN ? el.n : '', !conf.hintN);
        const zGroup = document.getElementById('input-z-group');
        const mGroup = document.getElementById('input-m-group');
        if (conf.reqZ) { zGroup.style.display = 'block'; document.getElementById('input-z').value = ''; document.getElementById('input-z').disabled = false; } else { zGroup.style.display = 'none'; }
        if (conf.reqM) { mGroup.style.display = 'block'; document.getElementById('input-m').value = ''; document.getElementById('input-m').disabled = false; } else { mGroup.style.display = 'none'; }
        
        const attempts = gameState.elements[el.z].attempts;
        document.getElementById('attempt-counter').innerText = `Intent ${attempts + 1} de 3`;
        document.getElementById('modal-overlay').style.display = 'flex';
        
        setTimeout(() => {
            if (!conf.hintS) document.getElementById('input-symbol').focus();
            else if (!conf.hintN) document.getElementById('input-name').focus(); 
            else if (conf.reqZ) document.getElementById('input-z').focus();
        }, 50);
    }

    function setupModalField(id, val, editable) {
        const input = document.getElementById(id);
        input.value = val;
        input.disabled = !editable;
        input.style.backgroundColor = editable ? 'var(--bg-body)' : 'var(--bg-hover)';
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    function checkAnswer() {
        const sInput = document.getElementById('input-symbol').value.trim();
        const nInput = document.getElementById('input-name').value.trim();
        const zInput = document.getElementById('input-z').value.trim();
        const mInput = document.getElementById('input-m').value.replace(',','.').trim();
        const clean = (str) => str.toLowerCase().normalize("NFC").replace(/\u0140/g, "l¬∑").replace(/\u013F/g, "l¬∑").replace(/≈Ä/g, "l¬∑");
        const isS = clean(sInput) === clean(currentTarget.s);
        const normalizeLoose = (str) => str.replace(/¬∑/g, "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const isN = normalizeLoose(clean(nInput)) === normalizeLoose(clean(currentTarget.n));
        let isZ = true; if(conf.reqZ) isZ = (parseInt(zInput) === currentTarget.z);
        let isM = true; if(conf.reqM) isM = (parseFloat(mInput).toFixed(conf.prec) === formatMass(currentTarget.m));
        
        const state = gameState.elements[currentTarget.z];
        const msgBox = document.getElementById('error-msg');

        if (isS && isN && isZ && isM) { 
            cellSuccess(state.attempts); 
        } else {
            state.attempts++;
            msgBox.style.display = 'block';
            
            let errors = [];
            if (!isS) errors.push("S√≠mbol incorrecte");
            if (!isN) errors.push("Nom incorrecte");
            if (!isZ) errors.push("N√∫mero Z incorrecte");
            if (!isM) errors.push("Massa incorrecta");

            if (state.attempts === 1) {
                // PRIMER ERROR: Llima (Verd√≥s)
                msgBox.className = 'error-msg error-lime';
                msgBox.innerHTML = "<strong>Incorrecte</strong><br>Revisa les dades i torna-ho a provar.";
            } else if (state.attempts === 2) {
                // SEGON ERROR: Taronja (Diferenciat)
                msgBox.className = 'error-msg error-orange';
                msgBox.innerHTML = `<strong>Atenci√≥!</strong><br>${errors.join('<br>')}`;
            } else {
                // TERCER ERROR: Vermell
                alert(`Has esgotat els intents.\n\nSoluci√≥:\n${currentTarget.n} (${currentTarget.s})\nZ: ${currentTarget.z}\nM: ${formatMass(currentTarget.m)}`); 
                cellSuccess(3);
                return;
            }
            
            document.getElementById('attempt-counter').innerText = `Intent ${state.attempts + 1} de 3`; 
        }
    }

    function cellSuccess(prevAttempts) {
        let finalClass = '';
        
        if (gameState.elements[currentTarget.z].peeked) { 
            finalClass = 'st-peek'; 
            gameState.elements[currentTarget.z].status = 'peeked'; 
        }
        else if (prevAttempts === 0) { 
            finalClass = 'st-perfect'; 
            gameState.elements[currentTarget.z].status = 'perfect'; 
        }
        else if (prevAttempts === 1) { 
            // 1 Error = Groc/Or
            finalClass = 'st-good'; 
            gameState.elements[currentTarget.z].status = 'good'; 
        }
        else if (prevAttempts === 2) { 
            // 2 Errors = Taronja
            finalClass = 'st-avg'; 
            gameState.elements[currentTarget.z].status = 'avg'; 
        }
        else { 
            // 3+ Errors = Vermell
            finalClass = 'st-bad'; 
            gameState.elements[currentTarget.z].status = 'bad'; 
        }
        
        currentCell.classList.add('done', finalClass);
        currentCell.classList.remove('flash-target');
        closeModal();
        findNextTarget();
    }

    function findNextTarget() {
        const currentIndex = gameState.verticalOrder.indexOf(currentTarget ? currentTarget.z : -1);
        let nextZ = null;

        for (let i = currentIndex + 1; i < gameState.verticalOrder.length; i++) { 
            if (gameState.elements[gameState.verticalOrder[i]].status === 'pending') { 
                nextZ = gameState.verticalOrder[i]; break; 
            } 
        }
        if (!nextZ) { 
            for (let i = 0; i < gameState.verticalOrder.length; i++) { 
                if (gameState.elements[gameState.verticalOrder[i]].status === 'pending') { 
                    nextZ = gameState.verticalOrder[i]; break; 
                } 
            } 
        }
        
        document.querySelectorAll('.auto-selected').forEach(c => c.classList.remove('auto-selected'));
        document.querySelectorAll('.flash-target').forEach(c => c.classList.remove('flash-target'));
        document.querySelectorAll('.flash-locked').forEach(c => c.classList.remove('flash-locked'));

        autoSelectedZ = nextZ;
        
        if (nextZ) { 
            const nextCell = document.querySelector(`.element-cell[data-z="${nextZ}"]`); 
            if(nextCell) { 
                if (conf.isFlashcard) {
                    nextCell.classList.add('flash-target');
                    document.querySelectorAll('.element-cell:not(.done):not(.flash-target)').forEach(c => c.classList.add('flash-locked'));
                } else {
                    nextCell.classList.add('auto-selected');
                }
                nextCell.scrollIntoView({behavior: "smooth", block: "center", inline: "center"}); 
            } 
        } else { showStats(); }
    }

    function showStats() {
        if (!gameState.startTime) return;
        const now = Date.now();
        const diff = Math.floor((now - gameState.startTime) / 1000);
        let doneCount = 0;
        const counts = { perfect: [], good: [], avg: [], bad: [], peeked: [] };
        
        gameState.activeList.forEach(z => { 
            const st = gameState.elements[z].status; 
            if(st !== 'pending') { 
                doneCount++; 
                if(counts[st]) counts[st].push(db.find(e=>e.z===z)); 
            } 
        });
        
        document.getElementById('st-time').innerText = `${Math.floor(diff/60).toString().padStart(2,'0')}:${(diff%60).toString().padStart(2,'0')}`;
        document.getElementById('st-total').innerText = `${doneCount}/${gameState.activeList.length}`;
        const listContainer = document.getElementById('stats-lists');
        listContainer.innerHTML = '';
        
        const labels = { perfect: "Perfecte (0 errors)", good: "B√© (1 error)", avg: "Regular (2 errors)", bad: "Fallat (+3 errors)", peeked: "Amb Pista" };
        const colors = { perfect: "var(--st-perfect-br)", good: "var(--st-good-br)", avg: "var(--st-avg-br)", bad: "var(--st-bad-br)", peeked: "var(--st-peek-br)" };
        
        Object.keys(counts).forEach(k => { 
            if(counts[k].length) { 
                const d = document.createElement('div'); 
                d.style.marginBottom = "10px"; 
                d.innerHTML = `<strong style="color:${colors[k]}">${labels[k]}</strong>: <br>${counts[k].map(e=>e.s).join(', ')}`; 
                listContainer.appendChild(d); 
            } 
        });
        document.getElementById('stats-overlay').style.display = 'flex';
    }

    document.getElementById('modal-box').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.stopPropagation(); checkAnswer(); } });

</script>
</body>
</html>
